<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOCOTECompli.com</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  
</head>
<body>
  <h1>SOCOTECompli</h1>

  <div class="input-group">
    <input type="text" id="addressInput" placeholder="Enter building address...">
    <button id="searchBtn">Search</button>
  </div>

  <div class="container">
    <div class="logo-container">
      <img src="https://www.ceca.co.uk/wp-content/uploads/2018/06/SOCOTEC-LOGO.png">
      <div class="logo-title">SOCOTECompli</div>
    </div>

    <div class="search-group">
        <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
            </svg>
        </span>
        <input type="text" id="mainSearchInput" class="search-input" placeholder="Enter building address">
    </div>

    <div id="preview" class="preview-container" style="display:none;">
      <h3>Report Preview</h3>
      <p><strong>Address:</strong> <span id="previewAddress"></span></p>
      <p><strong>Building Owner/Manager:</strong> <span id="previewOwner"></span></p>
      <p><strong>Borough:</strong> <span id="previewBorough"></span></p>
      <p><strong>FISP Compliance Status:</strong> <span id="previewFISP"></span></p>
      <button id="downloadBtn" class="generate-button">Download Full Report</button>
    </div>
  </div>

  <script>

 
    const mainSearchInput = document.getElementById('mainSearchInput');
    const searchBtn = document.getElementById('searchBtn'); 
    const downloadBtn = document.getElementById('downloadBtn');
    const messageEl = document.getElementById('message');
    const previewEl = document.getElementById('preview');

    let currentPreview = null;

    const handleSearch = async () => {
      const address = mainSearchInput.value.trim(); 
      if (!address) {
        messageEl.textContent = "Please enter an address or owner/management company.";
        return;
      }

      messageEl.textContent = "Searching...";
      previewEl.style.display = "none";

      try {
        const res = await fetch('/api/search-address', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address }) 
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No compliance data found.');

        currentPreview = data;

        document.getElementById('previewAddress').textContent = data.Address || 'N/A';
        document.getElementById('previewOwner').textContent = data["Building Owner/Manager"] || 'N/A';
        document.getElementById('previewBorough').textContent = data.Borough || 'N/A';
        document.getElementById('previewFISP').textContent = data["FISP Compliance Status"] || 'N/A';

        previewEl.style.display = "block";
        messageEl.textContent = '';

      } catch (err) {
        messageEl.textContent = err.message;
        currentPreview = null;
      }
    };

    searchBtn.addEventListener('click', handleSearch);
    mainSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSearch();
            e.preventDefault();
        }
    });

    
    downloadBtn.addEventListener('click', async () => {
      if (!currentPreview) {
        messageEl.textContent = "No data to generate report.";
        return;
      }

      //downloading report
      messageEl.textContent = "Generating report...";

      try {
        const res = await fetch('/api/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: currentPreview.Address })
        });

        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.error || 'Failed to generate report.');
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Compliance_Report.docx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        messageEl.textContent = "Report downloaded successfully!";

      } catch (err) {
        messageEl.textContent = err.message;
      }
    });
  </script>
</body>
</html>